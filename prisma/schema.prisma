// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Barbershop {
  id                        Int              @id @default(autoincrement())
  name                      String
  city                      String
  address                   String?
  phone                     String?

  // ✅ Slug único para link público (ej: /joacobarber)
  slug                      String?          @unique

  // Config SaaS
  defaultDepositPercentage  Int              @default(15)  // recomendado 15%
  platformFee               Int              @default(200) // tu comisión por turno (pesos)

  services                  Service[]
  appointments              Appointment[]
  users                     BarbershopUser[]

  // ✅ NUEVO
  workingHours              WorkingHour[]
}

model Service {
  id              Int        @id @default(autoincrement())
  barbershopId    Int
  barbershop      Barbershop @relation(fields: [barbershopId], references: [id])

  name            String
  price           Int        // pesos enteros
  durationMinutes Int        @default(30)

  // ✅ NUEVO
  description     String?

  // si es null, usa el defaultDepositPercentage de la barbería
  depositPercentage Int?

  appointments    Appointment[]
}

model Appointment {
  id            Int      @id @default(autoincrement())
  barbershopId  Int
  serviceId     Int

  customerName  String
  customerPhone String

  // ✅ NUEVO
  customerEmail String?
  notes         String?

  date          String
  time          String

  // estados SaaS
  status        String   @default("pending") // pending | confirmed | canceled
  paymentStatus String   @default("unpaid")  // unpaid | paid | refunded

  // snapshot al momento de reservar
  depositPercentageAtBooking Int @default(0)
  depositAmount              Int @default(0) // pesos
  platformFee                Int @default(0) // pesos (tu comisión)
  totalToPay                 Int @default(0) // deposit + platformFee

  createdAt     DateTime @default(now())

  barbershop    Barbershop @relation(fields: [barbershopId], references: [id])
  service       Service    @relation(fields: [serviceId], references: [id])

  // ✅ Evita doble reserva: misma barbería + mismo día + misma hora
  @@unique([barbershopId, date, time])
}

model BarbershopUser {
  id           Int        @id @default(autoincrement())
  barbershopId Int
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])

  name         String
  email        String     @unique
  passwordHash String
  role         String     @default("owner")

  createdAt    DateTime   @default(now())
}

model WorkingHour {
  id           Int        @id @default(autoincrement())
  barbershopId Int
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])

  weekday      Int        // 0=Dom ... 6=Sáb
  startTime    String     // "10:00"
  endTime      String     // "13:30"

  @@index([barbershopId, weekday])
  @@unique([barbershopId, weekday, startTime, endTime])
}
